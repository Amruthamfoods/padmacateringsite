generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int            @id @default(autoincrement())
  name          String
  email         String         @unique
  phone         String?
  passwordHash  String
  role          Role           @default(CUSTOMER)
  createdAt     DateTime       @default(now())
  bookings      Booking[]
  quoteRequests QuoteRequest[]
}

enum Role {
  CUSTOMER
  ADMIN
}

model MenuCategory {
  id           Int                   @id @default(autoincrement())
  name         String
  sortOrder    Int                   @default(0)
  active       Boolean               @default(true)
  items        MenuItem[]
  packageRules PackageCategoryRule[]
}

model MenuItem {
  id          Int               @id @default(autoincrement())
  name        String
  description String?
  image       String?
  categoryId  Int
  category    MenuCategory      @relation(fields: [categoryId], references: [id])
  style       CuisineStyle      @default(ANDHRA)
  type        DietType          @default(VEG)
  active      Boolean           @default(true)
  price       Float             @default(0)
  packages       MenuPackageItem[]
  bookings       BookingMenuItem[]
  allowedInRules PackageCategoryRuleItem[]
}

enum CuisineStyle {
  ANDHRA
  NORTH_INDIAN
  MIXED
  FUSION
}

enum DietType {
  VEG
  NON_VEG
}

model MenuPackage {
  id            Int                   @id @default(autoincrement())
  name          String
  eventType     String?
  style         CuisineStyle          @default(ANDHRA)
  type          DietType              @default(VEG)
  servesMin     Int                   @default(50)
  description   String?
  basePrice     Float                 @default(0)
  items         MenuPackageItem[]
  pricingTiers  PackagePricingTier[]
  categoryRules PackageCategoryRule[]
}

model PackagePricingTier {
  id             Int         @id @default(autoincrement())
  packageId      Int
  package        MenuPackage @relation(fields: [packageId], references: [id], onDelete: Cascade)
  minGuests      Int
  maxGuests      Int?
  pricePerPerson Float
}

model PackageCategoryRule {
  id             Int                       @id @default(autoincrement())
  packageId      Int
  package        MenuPackage               @relation(fields: [packageId], references: [id], onDelete: Cascade)
  categoryId     Int
  category       MenuCategory              @relation(fields: [categoryId], references: [id])
  label          String
  minChoices     Int                       @default(1)
  maxChoices     Int
  extraItemPrice Float                     @default(0)
  allowedItems   PackageCategoryRuleItem[]
}

model PackageCategoryRuleItem {
  id         Int                 @id @default(autoincrement())
  ruleId     Int
  rule       PackageCategoryRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  menuItemId Int
  menuItem   MenuItem            @relation(fields: [menuItemId], references: [id])

  @@unique([ruleId, menuItemId])
}

model MenuPackageItem {
  packageId  Int
  menuItemId Int
  package    MenuPackage @relation(fields: [packageId], references: [id])
  menuItem   MenuItem    @relation(fields: [menuItemId], references: [id])

  @@id([packageId, menuItemId])
}

enum QuoteStatus {
  PENDING
  REVIEWED
  QUOTED
  REJECTED
}

model QuoteRequest {
  id                  Int          @id @default(autoincrement())
  name                String
  email               String
  phone               String
  eventType           String
  eventDate           DateTime
  guestCount          Int
  venueAddress        String?
  servingStyle        ServingStyle
  specialInstructions String?
  selectedItemsJson   String
  status              QuoteStatus  @default(PENDING)
  adminNotes          String?
  createdAt           DateTime     @default(now())
  userId              Int?
  user                User?        @relation(fields: [userId], references: [id])
}

model Booking {
  id                  Int               @id @default(autoincrement())
  userId              Int?
  user                User?             @relation(fields: [userId], references: [id])
  packageId           Int?
  eventType           String
  eventDate           DateTime
  guestCount          Int
  vegCount            Int               @default(0)
  nonVegCount         Int               @default(0)
  venueAddress        String?
  servingStyle        ServingStyle      @default(BUFFET)
  deliveryType        DeliveryType      @default(GATE)
  deliveryCharge      Float             @default(0)
  staffCount          Int               @default(0)
  staffCharge         Float             @default(0)
  addonCharge         Float             @default(0)
  dietPreference      DietPreference    @default(NON_VEG)
  spiceLevel          SpiceLevel        @default(MEDIUM)
  timeSlot            String?
  paymentPlan         PaymentPlan       @default(FULL)
  status              BookingStatus     @default(PENDING)
  specialInstructions String?
  couponId            Int?
  coupon              Coupon?           @relation(fields: [couponId], references: [id])
  baseTotal           Float             @default(0)
  discount            Float             @default(0)
  gst                 Float             @default(0)
  total               Float             @default(0)
  guestName           String?
  guestPhone          String?
  guestEmail          String?
  razorpayOrderId     String?
  razorpayPaymentId   String?
  adminNotes          String?
  createdAt           DateTime          @default(now())
  menuItems           BookingMenuItem[]
}

enum ServingStyle {
  BUFFET
  BANANA_LEAF
  BOX_LUNCH
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum DeliveryType {
  GATE
  DOORSTEP
  DOORSTEP_SERVICE
}

enum DietPreference {
  VEG
  NON_VEG
  SEPARATE
}

enum SpiceLevel {
  MILD
  MEDIUM
  SPICY
}

enum PaymentPlan {
  FULL
  ADVANCE
}

model BookingMenuItem {
  bookingId  Int
  menuItemId Int
  booking    Booking  @relation(fields: [bookingId], references: [id])
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id])

  @@id([bookingId, menuItemId])
}

model Coupon {
  id            Int          @id @default(autoincrement())
  code          String       @unique
  discountType  DiscountType @default(FLAT)
  value         Float
  minOrderValue Float        @default(0)
  expiryDate    DateTime?
  usageLimit    Int?
  usedCount     Int          @default(0)
  active        Boolean      @default(true)
  bookings      Booking[]
}

enum DiscountType {
  FLAT
  PERCENTAGE
}

model BlockedDate {
  id     Int      @id @default(autoincrement())
  date   DateTime @unique
  reason String?
}
